const $=(s,e=document)=>e.querySelector(s),$$=(s,e=document)=>[...e.querySelectorAll(s)],state={cfg:null};
async function loadConfig(){const cfg=await (await fetch('./site.config.json',{cache:'no-store'})).json();applyTheme(getTheme());state.cfg=cfg;renderNav(cfg);renderQuickLinks(cfg);return cfg;}
function getTheme(){const t=localStorage.getItem('theme')||'auto';if(t==='auto'){return (matchMedia&&matchMedia('(prefers-color-scheme: dark)').matches)?'dark':'light'}return t}
function applyTheme(t){document.documentElement.dataset.theme=t}
function esc(s=''){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
function renderNav(cfg){const nav=$('#navlinks');if(nav){nav.innerHTML=cfg.navLinks.map(l=>`<a href="${l.href}">${esc(l.name)}</a>`).join('');const path=location.pathname.split('/').pop()||'index.html';$$('#navlinks a').forEach(a=>a.getAttribute('href').endsWith(path)&&a.setAttribute('aria-current','page'))}
const sel=$('#themeSelect');if(sel){sel.innerHTML=cfg.themes.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join('');sel.value=localStorage.getItem('theme')||'auto';sel.onchange=()=>{localStorage.setItem('theme',sel.value);applyTheme(getTheme());postGiscusTheme()}}
const q=$('#q'),ask=$('#askGemini'),open=$('#openGemini');if(ask&&q){ask.onclick=()=>askGemini(q.value);q.onkeydown=e=>e.key==='Enter'&&askGemini(q.value)}
if(open) open.onclick=()=>open('https://gemini.google.com/app','_blank','noopener')}
function renderQuickLinks(cfg){const el=$('#quickLinks');if(!el) return;let links=cfg.quickLinks;try{const s=localStorage.getItem('quickLinks');if(s){const a=JSON.parse(s);if(Array.isArray(a)&&a.length)links=a}}catch{}
el.innerHTML=links.map(x=>`<a class="item" href="${x.url}" target="_blank" rel="noopener">${esc(x.name)}<div class="meta">${esc(new URL(x.url).hostname)}</div></a>`).join('')}
function showModal(t,txt){const b=$('#modalBackdrop'),tt=$('#modalTitle'),bd=$('#modalBody');if(!b||!tt||!bd) return alert(txt);tt.textContent=t;bd.textContent=txt;b.style.display='flex'}
function hideModal(){const b=$('#modalBackdrop');if(b) b.style.display='none'}window.hideModal=hideModal;
async function askGemini(p){p=(p||'').trim();if(!p) return;const cfg=state.cfg||await loadConfig();const key=localStorage.getItem('GEMINI_API_KEY');const useProxy=!!cfg.gemini.useProxy&&cfg.gemini.proxyUrl;if(!useProxy&&!key){showModal('Gemini','未检测到 API Key。\n控制台：localStorage.setItem("GEMINI_API_KEY","你的key")\n或配置 proxy。');return}
const ep=(useProxy?cfg.gemini.proxyUrl:cfg.gemini.apiEndpoint).replace('{model}',encodeURIComponent(cfg.gemini.model));const url=useProxy?ep:`${ep}?key=${encodeURIComponent(key)}`;showModal('Gemini','思考中…');
try{const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:'user',parts:[{text:p}]}]})});const d=await r.json();const t=d?.candidates?.[0]?.content?.parts?.map(x=>x.text).join('')||d?.candidates?.[0]?.content?.parts?.[0]?.text||JSON.stringify(d,null,2);showModal('Gemini',t)}catch(e){showModal('Gemini','请求失败：'+e)}}
async function renderNews(n=10){const el=$('#newsList');if(!el) return;try{const j=await (await fetch('./data/news.json',{cache:'no-store'})).json();const items=(j.items||[]).slice(0,n);el.innerHTML=items.map(x=>{const d=x.published?new Date(x.published):null;const dt=d?d.toISOString().slice(0,10):'';return `<a class="item" href="${x.url}" target="_blank" rel="noopener"><div><b>${esc(x.title||'')}</b></div><div class="meta">${esc(x.source||'')} · ${esc(dt)}</div></a>`}).join('')||'<div class="item">暂无新闻（等待 workflow 抓取）</div>';const m=$('#newsMeta');if(m&&j.updated) m.textContent=`更新：${j.updated}`}catch{el.innerHTML='<div class="item">无法加载 news.json</div>'}}
async function renderPosts(){const el=$('#postList');if(!el) return;const q=$('#postSearch');let posts=[];try{posts=(await (await fetch('./data/posts.json',{cache:'no-store'})).json()).posts||[]}catch{}
const paint=(kw='')=>{kw=(kw||'').trim().toLowerCase();const f=kw?posts.filter(p=>`${p.title} ${p.summary||''} ${(p.tags||[]).join(' ')}`.toLowerCase().includes(kw)):posts;el.innerHTML=f.map(p=>`<a class="item" href="${p.url}"><div><b>${esc(p.title)}</b></div><div class="meta">${esc(p.date||'')} · ${esc((p.tags||[]).join(' / '))}</div></a>`).join('')||'<div class="item">暂无文章。把 markdown 放进 posts_md/ 然后运行 workflow 或脚本生成。</div>'};
paint('');if(q) q.oninput=()=>paint(q.value)}
function postGiscusTheme(){const f=document.querySelector('iframe.giscus-frame');if(!f) return;const theme=document.documentElement.dataset.theme==='dark'?'transparent_dark':'light';f.contentWindow?.postMessage({giscus:{setConfig:{theme}}},'https://giscus.app')}
addEventListener('DOMContentLoaded',async ()=>{await loadConfig();$('#modalBackdrop')?.addEventListener('click',e=>e.target.id==='modalBackdrop'&&hideModal());renderNews(10);renderPosts()});
